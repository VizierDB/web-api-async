#General
# Web service name
export VIZIERSERVER_NAME=vizier
#Log file directory used by the web server (DEFAULT: ./.vizierdb/logs)
export VIZIERSERVER_LOG_DIR=../../../.vizierdb/logs
# Flag indicating whether server is started in debug mode (DEFAULT: True)
export VIZIERSERVER_DEBUG=True

#Web Service
# Base URL of the server running the web service (DEFAULT: http://localhost)
export VIZIERSERVER_BASE_URL=http://localhost
# Public server port (DEFAULT: 5000)
export VIZIERSERVER_SERVER_PORT=5000
# Locally bound server port (DEFAULT: 5000)
export VIZIERSERVER_SERVER_LOCAL_PORT=5000
# Application path for Web API (DEFAULT: /vizier-db/api/v1)
export VIZIERSERVER_APP_PATH=/vizier-db/api/v1
# Default row limit for requests that read datasets (DEFAULT: 25)
export VIZIERSERVER_ROW_LIMIT=25
# Maximum row limit for requests that read datasets (DEFAULT: -1 (returns all rows))
export VIZIERSERVER_MAX_ROW_LIMIT=-1
# Maximum size for file uploads in bytes (DEFAULT: 16777216)
export VIZIERSERVER_MAX_UPLOAD_SIZE=16777216

#Workflow Execution Engine
# Name of the workflow execution engine (DEFAULT: DEV)
export VIZIERSERVER_ENGINE=MIMIR
# Path to the package declaration directory (DEFAULT: ./resources/packages/common)
export VIZIERSERVER_PACKAGE_PATH=../../../resources/packages/common:../../../resources/packages/mimir
# Path to the task processor definitions for supported packages (DEFAULT: ./resources/processors/common:./resources/processors/dev)
export VIZIERSERVER_PROCESSOR_PATH=../../../resources/processors/common:../../../resources/processors/mimir

#Workflow Engine
# Name of the execution backend. The currently implemented backends are CELERY, MULTIPROCESS, or CONTAINER (DEFAULT: MULTIPROCESS).
export VIZIERENGINE_BACKEND=MULTIPROCESS
# Colon separated list of package.command strings that identify the commands that are executed synchronously (DEFAULT: None)
export VIZIERENGINE_SYNCHRONOUS=
# Flag indicating whether short identifiers (eight characters instead of 32) are used by the viztrail repository (DEFAULT: True)
export VIZIERENGINE_USE_SHORT_IDENTIFIER=True
# Base data directory for storing data. The datastore, filestore, and viztrail repository will create sub-folders in the directory for maintaining information and resources they maintain.
export VIZIERENGINE_DATA_DIR=../../../.vizierdb

#CELERY Backend
# Colon separated list of package.command.queue strings that define routing information for individual commands (DEFAULT: None)
export VIZIERENGINE_CELERY_ROUTES=
# URL for the celery broker (DEFAULT: amqp://guest@localhost//)
export CELERY_BROKER_URL=amqp://guest@localhost//

#CELERY Worker Configuration
# Identifier for environment in which the worker operates (supported values are DEV, MIMIR, and REMOTE) (DEFAULT: DEV)
export VIZIERWORKER_export=MIMIR
# Path to the task processor definitions for supported packages (DEFAULT: ./resources/processors/common:./resources/processors/dev)
export VIZIERWORKER_PROCESSOR_PATH=../../../resources/processors/common:../../../resources/processors/mimir
# Log file directory used by the worker (DEFAULT: ./.vizierdb/logs/worker)
export VIZIERWORKER_LOG_DIR=../../../vizier/.vizierdb/logs/worker
# URL of the controlling web service (DEFAULT: http://localhost:5000/vizier-db/api/v1)
export VIZIERWORKER_CONTROLLER_URL=http://localhost:5000/vizier-db/api/v1

export MIMIR_HOST="127.0.0.1"
export MIMIR_URL="http://127.0.0.1:8089/api/v2"

export FLASK_APP=vizier.wsgi:app
export FLASK_ENV=development

CWDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
cd $CWDIR/../lib/python2.7/site-packages

trap "kill 0" EXIT

../../../mimir/mimir-api &
python -m flask run --with-threads &
#../../../bin/gunicorn -w 1 --threads 8 --bind 0.0.0.0:$VIZIERSERVER_SERVER_LOCAL_PORT vizier.wsgi:app

sleep 10
echo "vizier api is running:"
echo "access vizier ui in your browser at: $VIZIERSERVER_BASE_URL:$VIZIERSERVER_SERVER_PORT$VIZIERSERVER_APP_PATH/web-ui/vizier-db"

wait
